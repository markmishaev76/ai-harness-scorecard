name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install ruff
      - run: ruff check src/ tests/
      - run: ruff format --check src/ tests/

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: mypy src/

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: bandit -r src/ -c pyproject.toml

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: pip-audit

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - run: pytest --cov=ai_harness_scorecard --cov-report=term-missing

  docs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e ".[dev]"
      - name: Generate API docs
        run: |
          pip install pdoc
          pdoc ai_harness_scorecard --output-directory docs/api || true
      - name: Check documentation links
        run: |
          pip install lychee
          lychee --no-progress '*.md' 'docs/**/*.md' || true
      - name: Verify doc sync
        run: |
          for f in AGENTS.md ARCHITECTURE.md CONTRIBUTING.md SECURITY.md; do
            if [ ! -s "$f" ]; then
              echo "ERROR: $f is missing or empty"
              exit 1
            fi
          done
          echo "All required docs present"

  self-assess:
    runs-on: ubuntu-latest
    needs: [lint, typecheck, security, audit, test, docs]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -e .
      - run: ai-harness-scorecard assess . --format markdown -o scorecard-report.md
      - uses: actions/upload-artifact@v7
        with:
          name: scorecard-report
          path: scorecard-report.md
